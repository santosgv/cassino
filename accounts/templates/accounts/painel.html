{% extends 'base.html' %}
{% load static %}

{% block 'title' %}
Painel do Afiliado
{% endblock %}

{% block 'body' %}

<h2>Seu Saldo: R$ {{ affiliate.total_commission }}</h2>

<form method="post">
    {% csrf_token %}
    <label for="amount">Valor do Saque:</label>
    <input type="number" name="amount" step="0.01" required>
    <button type="submit">Solicitar Saque</button>
</form>

<h3>Histórico de Saques</h3>
<hr>
<table class="table table-striped text-center">
    <thead>
      <tr>
        <th scope="col">Valor</th>
        <th scope="col">Status</th>
        <th scope="col">Data</th>
        <th scope="col">Ação</th>
      </tr>
    </thead>
    <tbody>
        {% for withdrawal in affiliate.withdrawal_set.all %}
        <tr>
            <td>R$ {{ withdrawal.amount }}</td>
            <td>{{ withdrawal.status }}</td>
            <td>{{ withdrawal.requested_at }}</td>
            <td>
                {% if withdrawal.status == "Pendente" %}
                <button class="btn btn-primary" data-toggle="modal" data-target="#withdrawalModal"
                        data-id="{{ withdrawal.id }}" data-user="{{ withdrawal.affiliate.user.username }}"
                        data-amount="{{ withdrawal.amount }}" data-status="{{ withdrawal.status }}">
                    Gerenciar Saque
                </button>
                {% else %}
                <span class="text-muted">Finalizado</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="withdrawalModal" tabindex="-1" aria-labelledby="withdrawalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="withdrawalModalLabel">Gerenciar Solicitação de Saque</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Usuário:</strong> <span id="user-name"></span></p>
        <p><strong>Valor:</strong> R$ <span id="withdraw-amount"></span></p>
        <p><strong>Status:</strong> <span id="withdraw-status"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="deny-btn">Negar</button>
        <button type="button" class="btn btn-success" id="approve-btn">Aprovar</button>
      </div>
    </div>
  </div>
</div>

<!-- Script para preencher o modal corretamente -->
<script>
  $('#withdrawalModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget); 
      var id = button.data('id'); 
      var user = button.data('user');
      var amount = button.data('amount');
      var status = button.data('status');

      var modal = $(this);
      modal.find('#user-name').text(user);
      modal.find('#withdraw-amount').text(amount);
      modal.find('#withdraw-status').text(status);

      modal.find('#approve-btn').attr('onclick', `approveWithdrawal(${id})`);
      modal.find('#deny-btn').attr('onclick', `denyWithdrawal(${id})`);
  });

  function approveWithdrawal(id) {
    window.location.href = `/approve_withdrawal/${id}/`;
  }

  function denyWithdrawal(id) {
    window.location.href = `/deny_withdrawal/${id}/`;
  }
</script>

{% endblock %}
