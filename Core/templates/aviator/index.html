{% extends 'base.html' %}
{% load static %}
    <title>{% block 'title' %}
        Aviator Game
        {% endblock %}</title>
        {% block 'head' %}

        <style>
            #game-area {
                position: relative;
                width: 100%;
                height: 300px;
                border: 1px solid #ccc;
                overflow: hidden;
            }
            #airplane {
                position: absolute;
                bottom: 0;
                left: 50%;
                width: 50px;
                height: 50px;
                background-image: url('https://img.icons8.com/emoji/48/airplane-emoji.png'); /* Adicione um ícone de avião */
                background-size: cover;
                transition: bottom 5s linear, transform 5s ease-in-out;
            }
            #multiplier-display {
                font-size: 24px;
                font-weight: bold;
                margin-top: 20px;
            }
        </style>
        {% endblock %}

        {% block 'body' %}
        <h1>Aviator Game</h1>
        <form id="bet-form">
            <input type="number" name="bet_amount" placeholder="Enter bet amount" required>
            <button type="submit">Start Game</button>
        </form>
        <div id="game-area">
            <div id="airplane"></div>
        </div>
        <p>Multiplier: <span id="multiplier">1.0</span></p>
        <button id="cash-out" disabled>Cash Out</button>
        <p id="result"></p>
    
        <script>
            let currentMultiplier = 1.0;
            let intervalId;
            let gameActive = false;
    
            // Função para atualizar o multiplicador
            function updateMultiplier() {
                currentMultiplier += 0.1;
                document.getElementById('multiplier').textContent = currentMultiplier.toFixed(2);
            }
    
            // Função para animar o avião decolando
            function animateAirplane() {
                const airplane = document.getElementById('airplane');
                airplane.style.bottom = '100%'; // Move o avião para cima
                airplane.style.transform = 'rotate(45deg)'; // Gira o avião para simular decolagem
            }
    
            // Função para iniciar o jogo
            document.getElementById('bet-form').addEventListener('submit', function (e) {
                e.preventDefault();
                if (gameActive) return;
    
                const betAmount = document.querySelector('input[name="bet_amount"]').value;
                if (!betAmount || betAmount <= 0) {
                    alert('Por favor, insira um valor de aposta válido.');
                    return;
                }
    
                // Resetar o jogo
                currentMultiplier = 1.0;
                document.getElementById('multiplier').textContent = '1.0';
                document.getElementById('result').textContent = '';
                document.getElementById('cash-out').disabled = false;
                gameActive = true;
    
                // Iniciar a animação do avião
                animateAirplane();
    
                // Iniciar o timer de 5 segundos
                setTimeout(() => {
                    if (gameActive) {
                        fetch('/start_game/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': getCookie('csrftoken'), // Adicione o token CSRF
                            },
                            body: `bet_amount=${betAmount}`,
                        })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('result').textContent = `Resultado: ${data.result}`;
                            gameActive = false;
                            document.getElementById('cash-out').disabled = true;
                        });
                    }
                }, 5000); // 5 segundos
    
                // Atualizar o multiplicador a cada 500ms
                intervalId = setInterval(updateMultiplier, 500);
            });
    
            // Função para retirar o lucro
            document.getElementById('cash-out').addEventListener('click', function () {
                if (!gameActive) return;
    
                clearInterval(intervalId); // Parar de atualizar o multiplicador
                gameActive = false;
    
                fetch(`/cash_out/${sessionId}/?multiplier=${currentMultiplier}`) // Substitua sessionId pelo ID da sessão
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('result').textContent = `Você retirou: ${data.result}`;
                        document.getElementById('cash-out').disabled = true;
                    });
            });
    
            // Função para obter o token CSRF
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>
        {% endblock %}